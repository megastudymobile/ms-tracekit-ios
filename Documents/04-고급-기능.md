# âš™ï¸ ê³ ê¸‰ ê¸°ëŠ¥

> ì‘ì„±ì¼: 2025-12-15
> ì‘ì„±ì: jimmy

> ğŸ’¡ ì´ ë¬¸ì„œì˜ ì˜ˆì œì—ì„œ ì¼ë°˜ ë¡œê¹…ì€ ë™ê¸° API(`TraceKit.info(...)`)ë¥¼ ì‚¬ìš©í•˜ê³ ,
> ì„±ëŠ¥ ì¶”ì (span), flush ë“± ê²°ê³¼ê°€ í•„ìš”í•œ ê²½ìš°ë§Œ ë¹„ë™ê¸° API(`await TraceKit.shared...`)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

## ë¡œê·¸ ë²„í¼ë§

### ê°œìš”

ë²„í¼ë§ì€ ë¡œê·¸ ë©”ì‹œì§€ë¥¼ ëª¨ì•„ì„œ í•œ ë²ˆì— ì²˜ë¦¬í•˜ì—¬ I/O ì˜¤ë²„í—¤ë“œë¥¼ ì¤„ì…ë‹ˆë‹¤.

```mermaid
%%{init: {
  'theme': 'dark',
  'themeVariables': { 'lineColor': '#e2e8f0', 'textColor': '#f8fafc' }
}}%%
sequenceDiagram
    participant App as ğŸ“± App
    participant B as ğŸ“¦ Buffer
    participant D as ğŸ“¤ Destination

    App->>B: log #1
    App->>B: log #2
    App->>B: log #3
    
    Note over B: ë²„í¼ ê°€ë“ ë˜ëŠ” íƒ€ì´ë¨¸
    
    B->>D: flush([#1, #2, #3])
    D-->>B: done
```

### TraceBufferPolicy

```swift
public struct TraceBufferPolicy {
    let maxSize: Int              // ìµœëŒ€ ë²„í¼ í¬ê¸°
    let flushInterval: TimeInterval  // ìë™ í”ŒëŸ¬ì‹œ ê°„ê²©
    let flushOnLevel: TraceLevel?   // ì´ ë ˆë²¨ ì´ìƒì´ë©´ ì¦‰ì‹œ í”ŒëŸ¬ì‹œ
    let flushOnBackground: Bool   // ë°±ê·¸ë¼ìš´ë“œ ì§„ì… ì‹œ í”ŒëŸ¬ì‹œ
}
```

### í”„ë¦¬ì…‹

```swift
// ê¸°ë³¸ ì •ì±…
TraceBufferPolicy.default
// maxSize: 100, flushInterval: 5ì´ˆ, flushOnLevel: .error

// ì‹¤ì‹œê°„ (ë²„í¼ë§ ì—†ìŒ)
TraceBufferPolicy.realtime
// maxSize: 1, flushInterval: 0

// ë°°í„°ë¦¬ ì ˆì•½
TraceBufferPolicy.batterySaver
// maxSize: 200, flushInterval: 30ì´ˆ
```

### ì‚¬ìš©ë²•

```swift
let logger = await TraceKitBuilder()
    .addConsole()
    .withBuffer(policy: .default)
    .buildAsShared()

// ìˆ˜ë™ í”ŒëŸ¬ì‹œ
Task {
    await TraceKit.shared.flush()
}
```

### ì»¤ìŠ¤í…€ ì •ì±…

```swift
let customPolicy = TraceBufferPolicy(
    maxSize: 50,
    flushInterval: 10.0,
    flushOnLevel: .warning,  // warning ì´ìƒì€ ì¦‰ì‹œ í”ŒëŸ¬ì‹œ
    flushOnBackground: true
)

let logger = await TraceKitBuilder()
    .withBuffer(policy: customPolicy)
    .buildAsShared()
```

## ë¡œê·¸ ìƒ˜í”Œë§

### ê°œìš”

í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ë¡œê·¸ ë³¼ë¥¨ì„ ì œì–´í•©ë‹ˆë‹¤. ëª¨ë“  ë¡œê·¸ë¥¼ ìˆ˜ì§‘í•˜ë©´ ë¹„ìš©ì´ ì¦ê°€í•˜ê³  ë¶„ì„ì´ ì–´ë ¤ì›Œì§‘ë‹ˆë‹¤.

### SamplingPolicy

```swift
public struct SamplingPolicy {
    let defaultRate: Double           // ê¸°ë³¸ ë¹„ìœ¨ (0.0 ~ 1.0)
    let ratesByLevel: [TraceLevel: Double]   // ë ˆë²¨ë³„ ë¹„ìœ¨
    let ratesByCategory: [String: Double]  // ì¹´í…Œê³ ë¦¬ë³„ ë¹„ìœ¨
    let alwaysIncludeLevels: Set<TraceLevel> // í•­ìƒ í¬í•¨í•  ë ˆë²¨
}
```

### í”„ë¦¬ì…‹

```swift
// ë””ë²„ê·¸ìš© (100% ìˆ˜ì§‘)
SamplingPolicy.debug
// defaultRate: 1.0, alwaysIncludeLevels: ëª¨ë“  ë ˆë²¨

// í”„ë¡œë•ì…˜ìš©
SamplingPolicy.production
// defaultRate: 0.1 (10%)
// verbose: 1%, debug: 5%, info: 10%, warning: 50%
// error, fatal: 100%

// ìµœì†Œ ìƒ˜í”Œë§
SamplingPolicy.minimal
// defaultRate: 0.01 (1%)
// error, fatal: 100%
```

### ì‚¬ìš©ë²•

```swift
let logger = await TraceKitBuilder()
    .addConsole()
    .withSampling(policy: .production)
    .buildAsShared()
```

### ì»¤ìŠ¤í…€ ì •ì±…

```swift
let customPolicy = SamplingPolicy(
    defaultRate: 0.2,  // ê¸°ë³¸ 20%
    ratesByLevel: [
        .verbose: 0.0,   // verboseëŠ” ìˆ˜ì§‘í•˜ì§€ ì•ŠìŒ
        .debug: 0.05,    // debugëŠ” 5%
        .warning: 1.0    // warningì€ 100%
    ],
    ratesByCategory: [
        "Network": 0.5,  // Network ì¹´í…Œê³ ë¦¬ëŠ” 50%
        "Auth": 1.0      // Auth ì¹´í…Œê³ ë¦¬ëŠ” 100%
    ],
    alwaysIncludeLevels: [.error, .fatal]
)
```

### ìƒ˜í”Œë§ ë™ì‘ ì›ë¦¬

```swift
// 1. alwaysIncludeLevelsì— ìˆìœ¼ë©´ 100%
if alwaysIncludeLevels.contains(message.level) {
    return 1.0
}

// 2. ë ˆë²¨ë³„ ë¹„ìœ¨ì´ ìˆìœ¼ë©´ ìš°ì„ 
if let levelRate = ratesByLevel[message.level] {
    return levelRate
}

// 3. ì¹´í…Œê³ ë¦¬ë³„ ë¹„ìœ¨ì´ ìˆìœ¼ë©´ ì‚¬ìš©
if let categoryRate = ratesByCategory[message.category] {
    return categoryRate
}

// 4. ê¸°ë³¸ ë¹„ìœ¨
return defaultRate
```

## ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹

### ê°œìš”

ë¡œê·¸ì— í¬í•¨ë  ìˆ˜ ìˆëŠ” ë¯¼ê°ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ë§ˆìŠ¤í‚¹í•©ë‹ˆë‹¤.

### ê¸°ë³¸ íŒ¨í„´

| íŒ¨í„´ | ì˜ˆì‹œ | ë§ˆìŠ¤í‚¹ ê²°ê³¼ |
|-----|------|-----------|
| ì´ë©”ì¼ | `john@example.com` | `[EMAIL]` |
| ì‹ ìš©ì¹´ë“œ | `1234-5678-9012-3456` | `[CREDIT_CARD]` |
| ì „í™”ë²ˆí˜¸ | `010-1234-5678` | `[PHONE]` |
| IP ì£¼ì†Œ | `192.168.1.1` | `[IP_ADDRESS]` |
| JWT | `eyJhbGciOiJI...` | `[JWT_TOKEN]` |
| UUID | `550e8400-e29b-...` | `[UUID]` |
| ë¹„ë°€ë²ˆí˜¸ | `password=secret123` | `password=[MASKED]` |

### ì‚¬ìš©ë²•

```swift
// ê¸°ë³¸ ì •ì œê¸° ì‚¬ìš©
let logger = await TraceKitBuilder()
    .withDefaultSanitizer()
    .buildAsShared()

// ë§ˆìŠ¤í‚¹ ë™ì‘ (ë™ê¸° API ì‚¬ìš©)
TraceKit.info("ì‚¬ìš©ì ì´ë©”ì¼: john@example.com")
// ì¶œë ¥: "ì‚¬ìš©ì ì´ë©”ì¼: [EMAIL]"
```

### ì»¤ìŠ¤í…€ íŒ¨í„´ ì¶”ê°€

```swift
let customSanitizer = DefaultTraceSanitizer.Builder()
    // ê¸°ë³¸ íŒ¨í„´ì— ì¶”ê°€
    .add(try! SensitiveDataPattern(
        name: "Korean SSN",
        pattern: #"\d{6}-\d{7}"#,
        replacement: "[SSN]"
    ))
    .add(try! SensitiveDataPattern(
        name: "API Key",
        pattern: #"api[_-]?key[=:]\s*[\w-]+"#,
        replacement: "api_key=[REDACTED]"
    ))
    .build()

let logger = await TraceKitBuilder()
    .withSanitizer(customSanitizer)
    .buildAsShared()
```

### ë¹ˆ íŒ¨í„´ìœ¼ë¡œ ì‹œì‘

```swift
// ê¸°ë³¸ íŒ¨í„´ ì—†ì´ ì»¤ìŠ¤í…€ íŒ¨í„´ë§Œ ì‚¬ìš©
let minimalSanitizer = DefaultTraceSanitizer.Builder.empty()
    .add(try! SensitiveDataPattern(
        name: "Custom Secret",
        pattern: #"SECRET_\w+"#,
        replacement: "[SECRET]"
    ))
    .build()
```

### ë§ˆìŠ¤í‚¹ ë¹„í™œì„±í™”

```swift
// ì„¤ì •ì—ì„œ ë¹„í™œì„±í™”
let config = TraceKitConfiguration(isSanitizingEnabled: false)

// ë˜ëŠ” ì •ì œê¸° ìì²´ë¥¼ ë¹„í™œì„±í™”
let disabledSanitizer = DefaultTraceSanitizer(isEnabled: false)
```

## ì„±ëŠ¥ ì¶”ì 

### ê°œìš”

ì½”ë“œ ì‹¤í–‰ ì‹œê°„ì„ ì¸¡ì •í•˜ê³  ë¡œê·¸ë¡œ ê¸°ë¡í•©ë‹ˆë‹¤.

### ìë™ ì¸¡ì • (measure)

```swift
// í•¨ìˆ˜ ì‹¤í–‰ ì‹œê°„ ìë™ ì¸¡ì •
let result = await TraceKit.shared.measure(name: "ë°ì´í„° ë¡œë”©") {
    await loadData()
}

// ì¶œë ¥ ì˜ˆì‹œ:
// [PERF] ë°ì´í„° ë¡œë”©: 1.234s
```

### ìˆ˜ë™ ì¸¡ì • (Span)

```swift
// ì‹œì‘
let spanId = await TraceKit.shared.startSpan(name: "ë³µì¡í•œ ì‘ì—…")

// ... ì‘ì—… ìˆ˜í–‰ ...

// ì¢…ë£Œ (ë©”íƒ€ë°ì´í„° ì¶”ê°€ ê°€ëŠ¥)
await TraceKit.shared.endSpan(
    id: spanId,
    metadata: ["itemCount": AnyCodable(100)]
)
```

### ì¤‘ì²© Span

```swift
// ë¶€ëª¨ Span
let parentId = await TraceKit.shared.startSpan(name: "ì „ì²´ ì‘ì—…")

    // ìì‹ Span 1
    let child1Id = await TraceKit.shared.startSpan(
        name: "ë°ì´í„° ë¡œë”©",
        parentId: parentId
    )
    await loadData()
    await TraceKit.shared.endSpan(id: child1Id)
    
    // ìì‹ Span 2
    let child2Id = await TraceKit.shared.startSpan(
        name: "ë°ì´í„° ì²˜ë¦¬",
        parentId: parentId
    )
    await processData()
    await TraceKit.shared.endSpan(id: child2Id)

// ë¶€ëª¨ ì¢…ë£Œ
await TraceKit.shared.endSpan(id: parentId)
```

### ì‹¤ì „ ì˜ˆì œ: API í˜¸ì¶œ ì¶”ì 

```swift
actor NetworkService {
    func fetchUser(id: String) async throws -> User {
        let spanId = await TraceKit.shared.startSpan(name: "fetchUser")
        
        defer {
            Task {
                await TraceKit.shared.endSpan(id: spanId)
            }
        }
        
        // ë„¤íŠ¸ì›Œí¬ ìš”ì²­
        let requestSpan = await TraceKit.shared.startSpan(
            name: "HTTP Request",
            parentId: spanId
        )
        let (data, _) = try await urlSession.data(from: url)
        await TraceKit.shared.endSpan(id: requestSpan)
        
        // JSON íŒŒì‹±
        let parseSpan = await TraceKit.shared.startSpan(
            name: "JSON Parsing",
            parentId: spanId
        )
        let user = try decoder.decode(User.self, from: data)
        await TraceKit.shared.endSpan(id: parseSpan)
        
        return user
    }
}
```

## í¬ë˜ì‹œ ë¡œê·¸ ë³´ì¡´

### ê°œìš”

`CrashTracePreserver`ëŠ” ì•± í¬ë˜ì‹œ ì§ì „ì˜ ë¡œê·¸ë¥¼ íŒŒì¼ì— ë³´ì¡´í•˜ì—¬ í¬ë˜ì‹œ ì›ì¸ ë¶„ì„ì— í™œìš©í•©ë‹ˆë‹¤. mmap ê¸°ë°˜ìœ¼ë¡œ êµ¬í˜„ë˜ì–´ Signal Handlerì—ì„œë„ ì•ˆì „í•˜ê²Œ í¬ë˜ì‹œ ë§ˆì»¤ë¥¼ ê¸°ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ì£¼ìš” ê¸°ëŠ¥

- **Ring Buffer ê¸°ë°˜ ë¡œê·¸ ë³´ì¡´**: ìµœê·¼ Nê°œì˜ ë¡œê·¸ë¥¼ ë©”ëª¨ë¦¬ì— ìœ ì§€
- **JSON íŒŒì¼ ì €ì¥**: ì¼ë°˜ ì €ì¥ ì‹œ JSON í˜•ì‹ìœ¼ë¡œ íŒŒì¼ ê¸°ë¡
- **mmap ê¸°ë°˜ í¬ë˜ì‹œ ê°ì§€**: Signal Handlerì—ì„œ ë™ê¸° ì €ì¥ ê°€ëŠ¥
- **ìë™ ë³µêµ¬**: ë‹¤ìŒ ì‹¤í–‰ ì‹œ í¬ë˜ì‹œ ë¡œê·¸ ìë™ ë³µêµ¬

### ê¸°ë³¸ ì‚¬ìš©ë²•

```swift
let logger = await TraceKitBuilder()
    .addConsole()
    .withCrashPreservation(count: 50)  // ìµœê·¼ 50ê°œ ë¡œê·¸ ë³´ì¡´
    .buildAsShared()

// ë¡œê·¸ëŠ” ìë™ìœ¼ë¡œ ë³´ì¡´ë¨ (ë™ê¸° API ì‚¬ìš©)
TraceKit.info("ì‚¬ìš©ì ì•¡ì…˜")
TraceKit.error("ì˜¤ë¥˜ ë°œìƒ")
```

### í¬ë˜ì‹œ í›„ ë¡œê·¸ ë³µêµ¬

```swift
// ì•± ì‹œì‘ ì‹œ
@main
struct MyApp: App {
    init() {
        Task {
            await TraceKitSetup.configure()
            await checkPreviousCrash()
        }
    }
    
    static func checkPreviousCrash() async {
        if let crashLogs = await TraceKit.shared.recoverCrashLogs() {
            print("âš ï¸ ì´ì „ í¬ë˜ì‹œ ê°ì§€: \(crashLogs.count)ê°œ ë¡œê·¸ ë³µêµ¬ë¨")
            
            for log in crashLogs {
                print("  - [\(log.level)] \(log.message)")
            }
            
            // ì™¸ë¶€ ì„œë¹„ìŠ¤ë¡œ ì „ì†¡
            await analyticsService.sendCrashLogs(crashLogs)
            
            // ì •ë¦¬
            await TraceKit.shared.clearCrashLogs()
        }
    }
}
```

### ì§ì ‘ ì‚¬ìš©í•˜ê¸°

TraceKitì™€ ë…ë¦½ì ìœ¼ë¡œ `CrashTracePreserver`ë¥¼ ì§ì ‘ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
import TraceKit

// ì´ˆê¸°í™”
let preserver = CrashTracePreserver(preserveCount: 100)

// ë¡œê·¸ ê¸°ë¡
await preserver.record(TraceMessage(
    level: .info,
    message: "ì¤‘ìš”í•œ ì‘ì—… ì‹œì‘",
    category: "App"
))

// ì¼ë°˜ ì €ì¥ (ë¹„ë™ê¸°)
try await preserver.persist()

// í¬ë˜ì‹œ ì‹œë®¬ë ˆì´ì…˜ (ë™ê¸° ì €ì¥ - Signal Handlerìš©)
preserver.persistSync()

// í¬ë˜ì‹œ ë§ˆì»¤ í™•ì¸
if preserver.hasCrashData() {
    print("í¬ë˜ì‹œ ë§ˆì»¤ ê°ì§€ë¨")
}

// ë³µêµ¬
if let logs = try await preserver.recover() {
    print("ë³µêµ¬ëœ ë¡œê·¸: \(logs.count)ê°œ")
}

// mmap í¬ë˜ì‹œ ë§ˆì»¤ ì œê±°
preserver.clearMmapData()

// ì •ë¦¬ (Actorì—ëŠ” deinitì´ ì—†ìœ¼ë¯€ë¡œ ìˆ˜ë™ í˜¸ì¶œ í•„ìš”)
await preserver.cleanup()
```

### mmap ê¸°ë°˜ í¬ë˜ì‹œ ê°ì§€

#### persistSync() - Signal Handlerìš© ë™ê¸° ì €ì¥

Signal Handlerì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•œ ë™ê¸° í•¨ìˆ˜ë¡œ, mmapì— í¬ë˜ì‹œ ë§ˆì»¤ë¥¼ ì¦‰ì‹œ ê¸°ë¡í•©ë‹ˆë‹¤.

```swift
// Signal Handlerì—ì„œ ì‚¬ìš© ê°€ëŠ¥
preserver.persistSync()

// mmap íŒŒì¼ì— ê¸°ë¡ë˜ëŠ” ë‚´ìš©:
// CRASH\n
// 1734345678.123\n
```

**íŠ¹ì§•:**
- Signal-safe í•¨ìˆ˜ë§Œ ì‚¬ìš© (`memcpy`, `msync`)
- Actor isolation ìš°íšŒ (`nonisolated`)
- `os_unfair_lock`ìœ¼ë¡œ ìŠ¤ë ˆë“œ ì•ˆì „ì„± ë³´ì¥
- ìµœì†Œí•œì˜ ë°ì´í„° (í¬ë˜ì‹œ ë§ˆì»¤ + íƒ€ì„ìŠ¤íƒ¬í”„)ë§Œ ì €ì¥

#### hasCrashData() - í¬ë˜ì‹œ ë§ˆì»¤ í™•ì¸

```swift
if preserver.hasCrashData() {
    print("ì´ì „ í¬ë˜ì‹œ ê°ì§€ë¨")
}
```

#### clearMmapData() - í¬ë˜ì‹œ ë§ˆì»¤ ì œê±°

```swift
// ë³µêµ¬ í›„ ìˆ˜ë™ ì •ë¦¬ ë˜ëŠ” ì´ˆê¸°í™” ì‹œ ì‚¬ìš©
preserver.clearMmapData()
```

### ë¡œê·¸ íŒŒì¼ ìœ„ì¹˜

```
~/Library/Caches/crash_logs.json       # JSON ë¡œê·¸ íŒŒì¼
~/Library/Caches/crash_logs.mmap       # mmap í¬ë˜ì‹œ ë§ˆì»¤
```

ì‹œë®¬ë ˆì´í„°:
```
~/Library/Developer/CoreSimulator/Devices/{DEVICE_ID}/data/
  Containers/Data/Application/{APP_ID}/
  Library/Caches/crash_logs.json
  Library/Caches/crash_logs.mmap
```

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

#### 1. ê¸°ë³¸ ì €ì¥ ë° ë³µêµ¬

```swift
// ë¡œê·¸ ê¸°ë¡
await preserver.record(message1)
await preserver.record(message2)

// ì €ì¥
try await preserver.persist()

// ë³µêµ¬
let logs = try await preserver.recover()
// logs == [message1, message2]
```

#### 2. í¬ë˜ì‹œ ì‹œë®¬ë ˆì´ì…˜

```swift
// ë¡œê·¸ ê¸°ë¡
await preserver.record(crashLog)

// JSON íŒŒì¼ ì €ì¥
try await preserver.persist()

// mmap í¬ë˜ì‹œ ë§ˆì»¤ ê¸°ë¡ (Signal Handler ì‹œë®¬ë ˆì´ì…˜)
preserver.persistSync()

// ì•± ì¢…ë£Œ...

// ë‹¤ìŒ ì‹¤í–‰ ì‹œ
if preserver.hasCrashData() {
    print("í¬ë˜ì‹œ ê°ì§€!")
    let logs = try await preserver.recover()
    // logsì— crashLog í¬í•¨
}
```

#### 3. Ring Buffer ë™ì‘ í™•ì¸

```swift
let preserver = CrashTracePreserver(preserveCount: 3)

await preserver.record(log1)  // [log1]
await preserver.record(log2)  // [log1, log2]
await preserver.record(log3)  // [log1, log2, log3]
await preserver.record(log4)  // [log2, log3, log4] - log1 ì œê±°ë¨

let logs = await preserver.currentLogs()
// logs.count == 3
// logs[0] == log2 (ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ)
// logs[2] == log4 (ê°€ì¥ ìµœì‹ )
```

### Signal-safe ì œì•½ì‚¬í•­

Signal Handlerì—ì„œëŠ” ë‹¤ìŒ í•¨ìˆ˜ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤:

**âœ… ì‚¬ìš© ê°€ëŠ¥:**
- `memcpy`, `memset`
- `mmap`, `munmap`, `msync`
- `os_unfair_lock_lock`, `os_unfair_lock_unlock`
- `write` (íŒŒì¼ ë””ìŠ¤í¬ë¦½í„°)

**âŒ ì‚¬ìš© ë¶ˆê°€ëŠ¥:**
- `malloc`, `free`
- `printf`, `NSLog`
- `JSONEncoder`
- `async`/`await`
- Actor ë©”ì„œë“œ
- ëŒ€ë¶€ë¶„ì˜ Foundation API

`persistSync()`ëŠ” ì´ëŸ¬í•œ ì œì•½ì„ ì¤€ìˆ˜í•˜ì—¬ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤.

### ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

| ë°©ì‹ | ì†ë„ | Signal-safe | ìš©ë„ |
|-----|------|-------------|------|
| `persist()` (JSON) | ë³´í†µ | âŒ | ì¼ë°˜ ì €ì¥ |
| `persistSync()` (mmap) | ë§¤ìš° ë¹ ë¦„ | âœ… | í¬ë˜ì‹œ ì‹œ |

- **mmap í¬ê¸°**: 1MB ê³ ì •
- **ìµœì†Œ ë°ì´í„°**: "CRASH\níƒ€ì„ìŠ¤íƒ¬í”„\n"ë§Œ ì €ì¥
- **ì‚¬ì „ í• ë‹¹**: ì´ˆê¸°í™” ì‹œ íŒŒì¼ ìƒì„± ë° ë§¤í•‘

### ì£¼ì˜ì‚¬í•­

1. **Actor cleanup**: Actorì—ëŠ” `deinit`ì´ ì—†ìœ¼ë¯€ë¡œ `cleanup()` ë©”ì„œë“œë¥¼ ìˆ˜ë™ìœ¼ë¡œ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.

```swift
// ì•± ì¢…ë£Œ ì‹œ
await preserver.cleanup()
```

2. **mmap ì œí•œ**: mmapì—ëŠ” í¬ë˜ì‹œ ë§ˆì»¤ë§Œ ì €ì¥ë©ë‹ˆë‹¤. ì „ì²´ ë¡œê·¸ëŠ” JSON íŒŒì¼ì—ì„œ ë³µêµ¬í•©ë‹ˆë‹¤.

3. **Signal Handler ë“±ë¡**: í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” Signal Handler ë“±ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤ (ë³„ë„ êµ¬í˜„ í•„ìš”).

### TraceKitDemoì—ì„œ í™•ì¸í•˜ê¸°

TraceKitDemo ì•±ì˜ "Crash" íƒ­ì—ì„œ ë‹¤ìŒì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- ë¡œê·¸ ê¸°ë¡ ë° ì €ì¥
- í¬ë˜ì‹œ ì‹œë®¬ë ˆì´ì…˜ (`persistSync()` í˜¸ì¶œ)
- ì‹¤ì œ í¬ë˜ì‹œ (fatalError, nil!, array bounds ë“±)
- ë³µêµ¬ëœ ë¡œê·¸ í™•ì¸
- mmap í¬ë˜ì‹œ ë§ˆì»¤ ê´€ë¦¬

ìì„¸í•œ ë‚´ìš©ì€ [ë°ëª¨ ì•±](./07-ë°ëª¨-ì•±.md#6-crash-í¬ë˜ì‹œ-ë¡œê·¸-ë³´ì¡´) ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

## ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸

### ê°œìš”

ëª¨ë“  ë¡œê·¸ì— ìë™ìœ¼ë¡œ ì‚¬ìš©ì/ì•± ì •ë³´ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

### UserContext

```swift
public struct UserContext {
    let userId: String?
    let sessionId: String
    let appVersion: String
    let osVersion: String
    let deviceModel: String
    let environment: Environment
}
```

### ê¸°ë³¸ ì»¨í…ìŠ¤íŠ¸ ì œê³µì

```swift
let logger = await TraceKitBuilder()
    .withDefaultContextProvider(environment: .production)
    .buildAsShared()

// ë¡œê·¸ ì¶œë ¥ì— ìë™ í¬í•¨ (ë™ê¸° API ì‚¬ìš©)
TraceKit.info("ì‚¬ìš©ì ì•¡ì…˜")
// metadataì— appVersion, osVersion, deviceModel ìë™ ì¶”ê°€
```

### ì»¤ìŠ¤í…€ ì»¨í…ìŠ¤íŠ¸ ì œê³µì

```swift
actor MyContextProvider: UserContextProvider {
    func currentContext() async -> UserContext {
        return UserContext(
            userId: await AuthManager.shared.currentUserId,
            sessionId: SessionManager.current.id,
            appVersion: Bundle.main.appVersion,
            osVersion: UIDevice.current.systemVersion,
            deviceModel: UIDevice.current.model,
            environment: .production
        )
    }
}

let logger = await TraceKitBuilder()
    .withContextProvider(MyContextProvider())
    .buildAsShared()
```

## íŒŒì¼ ë¡œê·¸ ê´€ë¦¬

### TraceFileRetentionPolicy

```swift
public struct TraceFileRetentionPolicy {
    let maxFileSize: Int64     // ìµœëŒ€ íŒŒì¼ í¬ê¸°
    let maxFileCount: Int      // ìµœëŒ€ íŒŒì¼ ê°œìˆ˜
    let maxAge: TimeInterval   // ìµœëŒ€ ë³´ê´€ ê¸°ê°„
}
```

### í”„ë¦¬ì…‹

```swift
// ê¸°ë³¸
TraceFileRetentionPolicy.default
// 10MB, 5ê°œ, 7ì¼

// ìƒì„¸ ë³´ê´€
TraceFileRetentionPolicy.detailed
// 50MB, 10ê°œ, 30ì¼

// ìµœì†Œ ë³´ê´€
TraceFileRetentionPolicy.minimal
// 5MB, 3ê°œ, 3ì¼
```

### ì‚¬ìš©ë²•

```swift
let logger = await TraceKitBuilder()
    .addFile(
        minLevel: .info,
        retentionPolicy: TraceFileRetentionPolicy(
            maxFileSize: 20 * 1024 * 1024,  // 20MB
            maxFileCount: 10,
            maxAge: 14 * 24 * 3600          // 14ì¼
        )
    )
    .buildAsShared()
```

## ë‹¤ìŒ ë‹¨ê³„

- [ì™¸ë¶€ ì—°ë™](./05-ì™¸ë¶€-ì—°ë™.md) - Sentry, Datadog, Firebase ì—°ë™
- [ëŸ°íƒ€ì„ ì„¤ì •](./06-ëŸ°íƒ€ì„-ì„¤ì •.md) - Launch Arguments

