# ğŸ”Œ ì™¸ë¶€ ì—°ë™

> ì‘ì„±ì¼: 2025-12-15
> ì‘ì„±ì: jimmy

## ê°œìš”

TraceKitëŠ” `TraceDestination` í”„ë¡œí† ì½œì„ í†µí•´ ì™¸ë¶€ ëª¨ë‹ˆí„°ë§/ë¶„ì„ ì„œë¹„ìŠ¤ì™€ ì‰½ê²Œ ì—°ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³„ë„ ëª¨ë“ˆì´ ì•„ë‹Œ **í”„ë¡œí† ì½œ êµ¬í˜„**ìœ¼ë¡œ í†µí•©í•˜ë¯€ë¡œ ì˜ì¡´ì„±ì´ ê°€ë³ê³  ìœ ì—°í•©ë‹ˆë‹¤.

> ğŸ’¡ ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™ í›„ì—ë„ ë™ê¸° API(`TraceKit.error(...)`)ë¡œ ê°„í¸í•˜ê²Œ ë¡œê¹…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> ë‚´ë¶€ì ìœ¼ë¡œ Fire-and-Forget íŒ¨í„´ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

| ì—°ë™ ì„œë¹„ìŠ¤ | ìš©ë„ | êµ¬í˜„ ìƒíƒœ |
|---------|------|---------|
| Firebase Crashlytics | í¬ë˜ì‹œ ë¦¬í¬íŒ…, Breadcrumb | âœ… ë°ëª¨ ì•± êµ¬í˜„ |
| Firebase Analytics | ì´ë²¤íŠ¸ íŠ¸ë˜í‚¹ | âœ… ë°ëª¨ ì•± êµ¬í˜„ |
| Sentry | ì—ëŸ¬ ëª¨ë‹ˆí„°ë§, ì´ìŠˆ ì¶”ì  | ğŸ”§ ì‚¬ìš©ì êµ¬í˜„ ê°€ëŠ¥ |
| Datadog | ë¡œê·¸ ë¶„ì„, ë©”íŠ¸ë¦­ | ğŸ”§ ì‚¬ìš©ì êµ¬í˜„ ê°€ëŠ¥ |

## TraceDestination í”„ë¡œí† ì½œ

ëª¨ë“  ì™¸ë¶€ ì—°ë™ì€ `TraceDestination` í”„ë¡œí† ì½œì„ êµ¬í˜„í•˜ì—¬ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.

```swift
public protocol TraceDestination: Actor {
    var identifier: String { get }
    var minLevel: TraceLevel { get set }
    var isEnabled: Bool { get set }
    func log(_ message: TraceMessage) async
    func flush(_ messages: [TraceMessage]) async
}
```

## Firebase Crashlytics ì—°ë™

### ê°œìš”

ë°ëª¨ ì•±(`TraceKitDemo`)ì— êµ¬í˜„ëœ `FirebaseCrashlyticsTraceDestination`ì€ TraceKit ë¡œê·¸ë¥¼ Firebase Crashlyticsë¡œ ì „ì†¡í•˜ëŠ” ì‹¤ì œ êµ¬í˜„ ì˜ˆì‹œì…ë‹ˆë‹¤.

### ì„¤ì¹˜

1. Firebase SDK ì¶”ê°€ (SPM)

```swift
// Package.swift ë˜ëŠ” Tuist Dependencies.swift
.package(url: "https://github.com/firebase/firebase-ios-sdk", from: "10.0.0")
```

2. `GoogleService-Info.plist` ì¶”ê°€

### êµ¬í˜„ ì°¸ê³ 

ë°ëª¨ ì•±ì˜ êµ¬í˜„ì„ ì°¸ê³ í•˜ì—¬ í”„ë¡œì íŠ¸ì— ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```
Projects/TraceKitDemo/Sources/Infrastructure/
â”œâ”€â”€ FirebaseCrashlyticsTraceDestination.swift  # Crashlytics ì—°ë™
â””â”€â”€ FirebaseAnalyticsTraceDestination.swift    # Analytics ì—°ë™
```

### ì´ˆê¸°í™”

```swift
import TraceKit
import FirebaseCore
import FirebaseCrashlytics

@main
struct MyApp: App {
    init() {
        // Firebase ì´ˆê¸°í™”
        FirebaseApp.configure()
        
        Task {
            await setupTraceKit()
        }
    }
    
    @TraceKitActor
    func setupTraceKit() async {
        // ë°ëª¨ ì•± êµ¬í˜„ì„ ë³µì‚¬í•˜ê±°ë‚˜ ì§ì ‘ êµ¬í˜„
        let crashlyticsDestination = FirebaseCrashlyticsTraceDestination()
        
        let logger = await TraceKitBuilder()
            .addConsole()
            .addDestination(crashlyticsDestination)
            .buildAsShared()
    }
}
```

### ë™ì‘ ë°©ì‹

```mermaid
%%{init: {
  'theme': 'dark',
  'themeVariables': { 'lineColor': '#e2e8f0', 'textColor': '#f8fafc' }
}}%%
flowchart LR
    subgraph TraceKit
        L["TraceMessage"]
    end
    
    subgraph Crashlytics["FirebaseCrashlyticsTraceDestination"]
        LOG["log() - Breadcrumb"]
        REC["recordError() - ëª…ì‹œì  ì—ëŸ¬"]
    end
    
    subgraph Firebase["Firebase SDK"]
        CL["Crashlytics.log"]
        CE["Crashlytics.record"]
    end
    
    L -->|debug ì´ìƒ| LOG
    L -->|error ì´ìƒ| REC
    LOG --> CL
    REC --> CE
    
    classDef log fill:#3b82f6,stroke:#60a5fa,color:#ffffff
    classDef crash fill:#f59e0b,stroke:#fbbf24,color:#1f2937
    classDef firebase fill:#ef4444,stroke:#f87171,color:#ffffff
    
    class L log
    class LOG,REC crash
    class CL,CE firebase
```

| ë ˆë²¨ | Breadcrumb | recordError() |
|-----|-----------|---------------|
| verbose | âŒ | âŒ |
| debug | âœ… | âŒ |
| info | âœ… | âŒ |
| warning | âœ… | âŒ |
| error | âœ… | âœ… (Non-fatal) |
| fatal | âœ… | âœ… (Non-fatal) |

### êµ¬í˜„ ì˜ˆì‹œ

```swift
import Foundation
import TraceKit
import FirebaseCrashlytics

actor FirebaseCrashlyticsTraceDestination: TraceDestination {
    private nonisolated let crashlytics = Crashlytics.crashlytics()
    
    nonisolated var identifier: String { "firebase.crashlytics" }
    var minLevel: TraceLevel = .debug
    var isEnabled: Bool = true
    
    func log(_ message: TraceMessage) async {
        guard shouldLog(message) else { return }
        
        // Breadcrumbë¡œ ê¸°ë¡
        let breadcrumb = formatBreadcrumb(message)
        crashlytics.log(breadcrumb)
        
        // ì—ëŸ¬ ë ˆë²¨ì€ ëª…ì‹œì  ì—ëŸ¬ë¡œ ê¸°ë¡
        if message.level >= .error {
            recordError(message)
        }
    }
    
    private func formatBreadcrumb(_ message: TraceMessage) -> String {
        "[\(message.level.name)] [\(message.category)] \(message.message)"
    }
    
    private func recordError(_ message: TraceMessage) {
        let error = NSError(
            domain: "com.myapp",
            code: message.level.rawValue,
            userInfo: [
                NSLocalizedDescriptionKey: message.message,
                "category": message.category,
                "level": message.level.name
            ]
        )
        crashlytics.record(error: error)
    }
}
```

## Firebase Analytics ì—°ë™

### ê°œìš”

TraceKit ë¡œê·¸ë¥¼ Firebase Analytics ì´ë²¤íŠ¸ë¡œ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### êµ¬í˜„ ì˜ˆì‹œ

```swift
import Foundation
import TraceKit
import FirebaseAnalytics

actor FirebaseAnalyticsTraceDestination: TraceDestination {
    nonisolated var identifier: String { "firebase.analytics" }
    var minLevel: TraceLevel = .info
    var isEnabled: Bool = true
    
    func log(_ message: TraceMessage) async {
        guard shouldLog(message) else { return }
        
        // ì—ëŸ¬ ë ˆë²¨ë§Œ ì´ë²¤íŠ¸ë¡œ ì „ì†¡
        guard message.level >= .error else { return }
        
        Analytics.logEvent("trace_error", parameters: [
            "level": message.level.name,
            "category": message.category,
            "message": message.message,
            "file": message.fileName,
            "line": message.line
        ])
    }
}
```

## Sentry ì—°ë™ (êµ¬í˜„ ì˜ˆì‹œ)

### ì„¤ì¹˜

```swift
// Package.swift
.package(url: "https://github.com/getsentry/sentry-cocoa", from: "8.0.0")
```

### êµ¬í˜„ ì˜ˆì‹œ

```swift
import Foundation
import TraceKit
import Sentry

actor SentryTraceDestination: TraceDestination {
    private let dsn: String
    private let environment: String
    
    nonisolated var identifier: String { "sentry" }
    var minLevel: TraceLevel = .warning
    var isEnabled: Bool = true
    
    init(dsn: String, environment: String = "production") {
        self.dsn = dsn
        self.environment = environment
        
        // Sentry SDK ì´ˆê¸°í™”
        SentrySDK.start { options in
            options.dsn = dsn
            options.environment = environment
        }
    }
    
    func log(_ message: TraceMessage) async {
        guard shouldLog(message) else { return }
        
        // Breadcrumb ì¶”ê°€
        let breadcrumb = Breadcrumb(
            level: sentryLevel(from: message.level),
            category: message.category
        )
        breadcrumb.message = message.message
        SentrySDK.addBreadcrumb(breadcrumb)
        
        // ì—ëŸ¬ëŠ” ì´ë²¤íŠ¸ë¡œ ì „ì†¡
        if message.level >= .error {
            let event = Event(level: sentryLevel(from: message.level))
            event.message = SentryMessage(formatted: message.message)
            event.tags = ["category": message.category]
            SentrySDK.capture(event: event)
        }
    }
    
    private func sentryLevel(from level: TraceLevel) -> SentryLevel {
        switch level {
        case .verbose, .debug: return .debug
        case .info: return .info
        case .warning: return .warning
        case .error: return .error
        case .fatal: return .fatal
        }
    }
}
```

### ì‚¬ìš©ë²•

```swift
let sentryDestination = SentryTraceDestination(
    dsn: "https://xxx@sentry.io/123",
    environment: "production"
)

let logger = await TraceKitBuilder()
    .addConsole()
    .addDestination(sentryDestination)
    .buildAsShared()
```

## Datadog ì—°ë™ (êµ¬í˜„ ì˜ˆì‹œ)

### ì„¤ì¹˜

```swift
// Package.swift
.package(url: "https://github.com/DataDog/dd-sdk-ios", from: "2.0.0")
```

### êµ¬í˜„ ì˜ˆì‹œ

```swift
import Foundation
import TraceKit
import DatadogCore
import DatadogLogs

actor DatadogTraceDestination: TraceDestination {
    private let logger: LoggerProtocol
    
    nonisolated var identifier: String { "datadog" }
    var minLevel: TraceLevel = .info
    var isEnabled: Bool = true
    
    init(clientToken: String, environment: String, serviceName: String) {
        // Datadog SDK ì´ˆê¸°í™”
        Datadog.initialize(
            with: Datadog.Configuration(
                clientToken: clientToken,
                env: environment,
                service: serviceName
            ),
            trackingConsent: .granted
        )
        
        logger = Logger.create()
    }
    
    func log(_ message: TraceMessage) async {
        guard shouldLog(message) else { return }
        
        let attributes: [String: Encodable] = [
            "category": message.category,
            "file": message.fileName,
            "function": message.function,
            "line": message.line
        ]
        
        switch message.level {
        case .verbose, .debug:
            logger.debug(message.message, attributes: attributes)
        case .info:
            logger.info(message.message, attributes: attributes)
        case .warning:
            logger.warn(message.message, attributes: attributes)
        case .error:
            logger.error(message.message, attributes: attributes)
        case .fatal:
            logger.critical(message.message, attributes: attributes)
        }
    }
}
```

### ì‚¬ìš©ë²•

```swift
let datadogDestination = DatadogTraceDestination(
    clientToken: "pub_xxx",
    environment: "production",
    serviceName: "my-ios-app"
)

let logger = await TraceKitBuilder()
    .addConsole()
    .addDestination(datadogDestination)
    .buildAsShared()
```

## ë³µí•© êµ¬ì„± ì˜ˆì œ

### ëª¨ë“  ì„œë¹„ìŠ¤ ì—°ë™

```swift
import TraceKit
import FirebaseCore

@TraceKitActor
func setupProductionTraceKit() async {
    // Firebase ì´ˆê¸°í™”
    FirebaseApp.configure()
    
    // Firebase Crashlytics (ë°ëª¨ ì•± êµ¬í˜„ ì°¸ì¡°)
    let crashlyticsDestination = FirebaseCrashlyticsTraceDestination()
    
    // Sentry (ì‚¬ìš©ì êµ¬í˜„)
    let sentryDestination = SentryTraceDestination(
        dsn: "https://xxx@sentry.io/123",
        environment: "production"
    )
    
    // Datadog (ì‚¬ìš©ì êµ¬í˜„)
    let datadogDestination = DatadogTraceDestination(
        clientToken: "pub_xxx",
        environment: "production",
        serviceName: "my-app"
    )
    
    // TraceKit êµ¬ì„±
    let logger = await TraceKitBuilder()
        // ë¡œì»¬ ì¶œë ¥
        .addConsole(minLevel: .warning)
        .addOSLog(minLevel: .info)
        .addFile(minLevel: .debug)
        
        // ì™¸ë¶€ ì„œë¹„ìŠ¤
        .addDestination(crashlyticsDestination)
        .addDestination(sentryDestination)
        .addDestination(datadogDestination)
        
        // ì •ì±…
        .withBuffer(policy: .default)
        .withSampling(policy: .production)
        .withDefaultSanitizer()
        .withDefaultContextProvider(environment: .production)
        
        .buildAsShared()
}
```

### í™˜ê²½ë³„ êµ¬ì„±

```swift
@TraceKitActor
func setupTraceKit(environment: Environment) async {
    let builder = TraceKitBuilder()
        .addConsole(formatter: PrettyTraceFormatter.verbose)
        .withDefaultSanitizer()
    
    switch environment {
    case .debug:
        // ë””ë²„ê·¸: ì½˜ì†”ë§Œ
        _ = await builder
            .with(configuration: .debug)
            .buildAsShared()
        
    case .staging:
        // ìŠ¤í…Œì´ì§•: ì½˜ì†” + Firebase
        FirebaseApp.configure()
        let crashlytics = FirebaseCrashlyticsTraceDestination()
        _ = await builder
            .addDestination(crashlytics)
            .buildAsShared()
        
    case .production:
        // í”„ë¡œë•ì…˜: ì „ì²´ êµ¬ì„±
        FirebaseApp.configure()
        let crashlytics = FirebaseCrashlyticsTraceDestination()
        let sentry = SentryTraceDestination(
            dsn: "https://xxx@sentry.io/prod",
            environment: "production"
        )
        
        _ = await builder
            .addOSLog(minLevel: .info)
            .addFile(minLevel: .info)
            .addDestination(crashlytics)
            .addDestination(sentry)
            .withBuffer(policy: .default)
            .withSampling(policy: .production)
            .buildAsShared()
    }
}
```

## ì»¤ìŠ¤í…€ Destination êµ¬í˜„ ê°€ì´ë“œ

### ê¸°ë³¸ êµ¬ì¡°

```swift
import Foundation
import TraceKit

actor MyCustomDestination: TraceDestination {
    // í•„ìˆ˜ í”„ë¡œí¼í‹°
    nonisolated var identifier: String { "my.custom" }
    var minLevel: TraceLevel = .info
    var isEnabled: Bool = true
    
    // ì´ˆê¸°í™”
    init(/* í•„ìš”í•œ ì„¤ì • */) {
        // SDK ì´ˆê¸°í™” ë“±
    }
    
    // í•„ìˆ˜ ë©”ì„œë“œ
    func log(_ message: TraceMessage) async {
        guard shouldLog(message) else { return }
        
        // ì™¸ë¶€ ì„œë¹„ìŠ¤ë¡œ ë¡œê·¸ ì „ì†¡
        await sendToExternalService(message)
    }
    
    // flushëŠ” ê¸°ë³¸ êµ¬í˜„ ì‚¬ìš© ê°€ëŠ¥ (ë°°ì¹˜ ì²˜ë¦¬ê°€ í•„ìš”í•œ ê²½ìš°ë§Œ override)
    func flush(_ messages: [TraceMessage]) async {
        // ë°°ì¹˜ ì „ì†¡ ìµœì í™”
        for message in messages {
            await log(message)
        }
    }
    
    private func sendToExternalService(_ message: TraceMessage) async {
        // êµ¬í˜„
    }
}
```

### êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] `TraceDestination` í”„ë¡œí† ì½œ ì±„íƒ
- [ ] `identifier`ë¥¼ ê³ ìœ í•œ ê°’ìœ¼ë¡œ ì„¤ì •
- [ ] `log(_:)` ë©”ì„œë“œì—ì„œ `shouldLog(_:)` í™•ì¸
- [ ] Actorë¡œ êµ¬í˜„í•˜ì—¬ ìŠ¤ë ˆë“œ ì•ˆì „ì„± ë³´ì¥
- [ ] ì™¸ë¶€ SDK ì´ˆê¸°í™” ìˆœì„œ ê³ ë ¤
- [ ] ì—ëŸ¬ ì²˜ë¦¬ ë° ì¬ì‹œë„ ë¡œì§ êµ¬í˜„
- [ ] ë¯¼ê°ì •ë³´ëŠ” ì´ë¯¸ ì •ì œëœ ìƒíƒœë¡œ ìˆ˜ì‹ ë¨ (ì¶”ê°€ ì²˜ë¦¬ ë¶ˆí•„ìš”)

## ë°ëª¨ ì•±ì—ì„œ í™•ì¸í•˜ê¸°

TraceKitDemo ì•±ì—ì„œ ì‹¤ì œ êµ¬í˜„ ì˜ˆì‹œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- **Firebase Crashlytics ì—°ë™**: `CrashlyticsRealtime` íƒ­
- **Firebase Analytics ì—°ë™**: `AnalyticsRealtime` íƒ­
- **êµ¬í˜„ ì½”ë“œ**: `Projects/TraceKitDemo/Sources/Infrastructure/`

ìì„¸í•œ ë‚´ìš©ì€ [ë°ëª¨ ì•±](./07-ë°ëª¨-ì•±.md) ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

## ë¬¸ì œ í•´ê²°

### Firebase ë¡œê·¸ê°€ ë³´ì´ì§€ ì•ŠìŒ

1. `GoogleService-Info.plist` í™•ì¸
2. `FirebaseApp.configure()` í˜¸ì¶œ í™•ì¸
3. í¬ë˜ì‹œ ë°œìƒ í›„ ì•± ì¬ì‹¤í–‰ í•„ìš”
4. ë””ë²„ê±° ì—°ê²° ì‹œ í¬ë˜ì‹œ ë¦¬í¬íŠ¸ ë¹„í™œì„±í™”ë¨

### ì™¸ë¶€ SDK ì´ˆê¸°í™” ìˆœì„œ

```swift
// ì˜¬ë°”ë¥¸ ìˆœì„œ
FirebaseApp.configure()          // 1. Firebase ì´ˆê¸°í™”
Datadog.initialize(...)          // 2. Datadog ì´ˆê¸°í™”
SentrySDK.start { ... }          // 3. Sentry ì´ˆê¸°í™”

// ê·¸ ë‹¤ìŒ TraceKit ì„¤ì •
await TraceKitBuilder()
    .addDestination(...)
    .buildAsShared()
```

### ìƒ˜í”Œë§ìœ¼ë¡œ ë¡œê·¸ê°€ í•„í„°ë§ë¨

ìƒ˜í”Œë§ ì •ì±…ì´ í™œì„±í™”ëœ ê²½ìš° ì¼ë¶€ ë¡œê·¸ê°€ ì™¸ë¶€ ì„œë¹„ìŠ¤ë¡œ ì „ì†¡ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠ¹ì • ì¹´í…Œê³ ë¦¬ë‚˜ ë ˆë²¨ì˜ ë¡œê·¸ë¥¼ 100% ì „ì†¡í•˜ë ¤ë©´ ìƒ˜í”Œë§ ì •ì±…ì„ ì¡°ì •í•˜ì„¸ìš”.

```swift
let policy = SamplingPolicy(
    defaultRate: 0.1,
    ratesByCategory: [
        "Auth": 1.0,      // Auth ì¹´í…Œê³ ë¦¬ëŠ” 100% ì „ì†¡
        "Payment": 1.0    // Payment ì¹´í…Œê³ ë¦¬ëŠ” 100% ì „ì†¡
    ],
    alwaysIncludeLevels: [.error, .fatal]
)
```

## ë‹¤ìŒ ë‹¨ê³„

- [ëŸ°íƒ€ì„ ì„¤ì •](./06-ëŸ°íƒ€ì„-ì„¤ì •.md) - Launch Argumentsë¡œ ë™ì  ì œì–´
- [ë°ëª¨ ì•±](./07-ë°ëª¨-ì•±.md) - Firebase ì—°ë™ ì‹¤ì œ êµ¬í˜„ í™•ì¸
